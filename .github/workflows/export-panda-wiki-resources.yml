name: Export Panda Wiki Resources

on:
  workflow_dispatch:

jobs:
  export-resources:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Download and export all resources
        run: |
          # 创建输出目录结构
          mkdir -p panda-wiki-resources/images
          
          COMPOSE_FILE="panda-wiki-resources/docker-compose.yml"
          DOWNLOAD_URL="https://release.baizhi.cloud/panda-wiki/docker-compose.yml"
          
          echo "=== 步骤 1/3: 下载 docker-compose.yml ==="
          if curl -fsSL -o "${COMPOSE_FILE}" "${DOWNLOAD_URL}"; then
              echo "✅ docker-compose.yml 下载成功"
          else
              echo "❌ 下载失败: ${DOWNLOAD_URL}"
              exit 1
          fi
          
          echo ""
          echo "=== 步骤 2/3: 拉取所有镜像 ==="
          if docker compose -f "${COMPOSE_FILE}" pull; then
              echo "✅ 镜像拉取成功"
          else
              echo "❌ 拉取失败"
              exit 1
          fi
          
          echo ""
          echo "=== 步骤 3/3: 导出镜像 ==="
          
          # 提取镜像列表
          IMAGES=$(grep 'image:' "${COMPOSE_FILE}" | awk -F 'image:' '{print $2}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sort -u)
          
          if [ -z "$IMAGES" ]; then
              echo "❌ 未找到镜像定义"
              exit 1
          fi
          
          echo "发现 $(echo "$IMAGES" | wc -l) 个镜像:"
          echo "$IMAGES"
          echo ""
          
          # 导出每个镜像到 images 目录
          for IMAGE in $IMAGES; do
              FILENAME=$(echo "$IMAGE" | sed 's/.*\///g' | sed 's/:/_/g')
              TAR_FILE="panda-wiki-resources/images/${FILENAME}.tar"
              
              echo "导出: ${IMAGE} -> images/${FILENAME}.tar"
              
              if docker save -o "${TAR_FILE}" "${IMAGE}"; then
                  ls -lh "${TAR_FILE}"
                  echo "✅ 成功导出"
              else
                  echo "❌ 导出失败: ${IMAGE}"
              fi
              echo ""
          done
          
          echo "=== 导出完成 ==="
          echo "资源目录结构:"
          find panda-wiki-resources -type f -exec ls -lh {} \;
      
      - name: Create final archive
        run: |
          echo "=== 创建最终压缩包 ==="
          
          # 创建压缩包（包含 docker-compose.yml 和 images/ 目录）
          tar -czf panda-wiki-resources.tar.gz panda-wiki-resources/
          
          echo "压缩包信息:"
          ls -lh panda-wiki-resources.tar.gz
          
          echo ""
          echo "压缩包内容预览:"
          tar -tzf panda-wiki-resources.tar.gz | head -20
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: panda-wiki-resources
          path: panda-wiki-resources.tar.gz
          retention-days: 7
