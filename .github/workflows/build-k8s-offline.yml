# .github/workflows/build-k8s-offline.yml
name: Build k8s-test offline bundle

on:
  workflow_dispatch:
    inputs:
      kk_version:
        description: 'KubeKey version'
        required: true
        default: 'v3.2.0'
      k8s_version:
        description: 'Kubernetes version'
        required: true
        default: 'v1.32.6'
      bundle_name:
        description: '离线包文件名（不含扩展名）'
        required: true
        default: 'k8s-test'

env:
  KK_VERSION:   ${{ github.event.inputs.kk_version }}
  K8S_VERSION:  ${{ github.event.inputs.k8s_version }}
  BUNDLE_NAME:  ${{ github.event.inputs.bundle_name }}

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update -y && sudo apt-get install -y curl

      - name: Download kk binary
        run: |
          curl -L -o kk https://github.com/kubesphere/kubekey/releases/download/${{ env.KK_VERSION }}/kk-linux-amd64
          chmod +x kk

      - name: Download package.sh
        run: |
          curl -L -o package.sh https://raw.githubusercontent.com/kubesphere/kubekey/${{ env.KK_VERSION }}/package.sh
          chmod +x package.sh

      - name: Replace K8s version in manifest
        run: sed -i "s|version: v1.32.6|version: ${{ env.K8S_VERSION }}|g" manifests/manifest-test.yaml

      - name: Build offline package
        run: |
          ./package.sh -m manifests/manifest-test.yaml -o ${{ env.BUNDLE_NAME }}.tgz
          ls -lh ${{ env.BUNDLE_NAME }}.tgz

      - name: Create/Update Release & Upload asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: k8s-offline          # 固定 tag，方便记忆
          name: Kubernetes Offline Bundle ${{ env.K8S_VERSION }}
          body: |
            KubeKey ${{ env.KK_VERSION }} + Kubernetes ${{ env.K8S_VERSION }} 离线包  
            生成时间：${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          files: ${{ env.BUNDLE_NAME }}.tgz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
