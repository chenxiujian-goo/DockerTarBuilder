name: build-k8s-offline-focal

on:
 workflow_dispatch:

permissions:
 contents: write

jobs:
 pack:
   runs-on: ubuntu-22.04
   steps:
     - uses: actions/checkout@v4

     - name: Create dist directories
       run: mkdir -p $GITHUB_WORKSPACE/dist/{bins,images,debs,cni}

     # 1. Download k8s binaries
     - name: Fetch k8s binaries (v1.27.13)
       run: |
         VER=v1.27.13
         ARCH=amd64
         for bin in kubeadm kubelet kubectl; do
           curl -L -o $GITHUB_WORKSPACE/dist/bins/${bin} \
             https://dl.k8s.io/release/${VER}/bin/linux/${ARCH}/${bin}
           chmod +x $GITHUB_WORKSPACE/dist/bins/${bin}
         done

     # 2. Download crictl v1.27.0
     - name: Fetch crictl
       run: |
         curl -L -o /tmp/crictl.tar.gz \
           https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.27.0/crictl-v1.27.0-linux-amd64.tar.gz
         tar -xzf /tmp/crictl.tar.gz -C $GITHUB_WORKSPACE/dist/bins/
         chmod +x $GITHUB_WORKSPACE/dist/bins/crictl

     # 3. Download containerd v1.6.24 (cri-containerd-cni) + pre-generate config.toml
     - name: Fetch containerd and generate config for focal
       run: |
         CONTAINERD_VER=v1.6.24
         TARBALL=cri-containerd-cni-${CONTAINERD_VER#v}-linux-amd64.tar.gz
         URL=https://github.com/containerd/containerd/releases/download/${CONTAINERD_VER}/${TARBALL}

         docker run --rm -v $GITHUB_WORKSPACE/dist:/out \
           ubuntu:20.04 bash -c "
             set -euo pipefail
             apt-get update -qq
             apt-get install -y wget ca-certificates
             wget -q '$URL' -O /tmp/containerd.tar.gz
             tar -xzf /tmp/containerd.tar.gz -C /
             /usr/local/bin/containerd config default > /tmp/config.toml
             sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /tmp/config.toml
             cp /tmp/containerd.tar.gz /out/bins/containerd-full.tar.gz
             cp /tmp/config.toml /out/containerd-config.toml
           "

     # 4. Fetch Ubuntu 20.04 (focal) system debs
     - name: Fetch focal debs
       run: |
         docker run --rm -v $GITHUB_WORKSPACE/dist/debs:/out \
           ubuntu:20.04 bash -c "
             set -euo pipefail
             apt-get update -qq
             apt-get install --reinstall --download-only -y \
               conntrack ebtables ethtool ipset ipvsadm socat iptables bridge-utils jq
             cp /var/cache/apt/archives/*.deb /out/
           "

     # 5. CNI plugins
     - name: Fetch CNI plugins
       run: |
         curl -L -o $GITHUB_WORKSPACE/dist/cni/cni-plugins.tgz \
           https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz

     # 6. Pull and save all required images (including etcd)
     - name: Save K8s core images
       run: |
         sudo systemctl start docker
         IMG=(
           registry.k8s.io/kube-apiserver:v1.27.13
           registry.k8s.io/kube-controller-manager:v1.27.13
           registry.k8s.io/kube-scheduler:v1.27.13
           registry.k8s.io/kube-proxy:v1.27.13
           registry.k8s.io/etcd:3.5.7-0
           registry.k8s.io/pause:3.9
           registry.k8s.io/coredns/coredns:v1.10.1
         )
         for im in "${IMG[@]}"; do
           sudo docker pull "$im" || { echo "Failed to pull $im"; exit 1; }
         done
         sudo docker save "${IMG[@]}" | gzip > $GITHUB_WORKSPACE/dist/images/k8s-images.tar.gz

     # 7. Bundle everything
     - name: Create final tarball
       run: |
         cd $GITHUB_WORKSPACE/dist
         tar czf $GITHUB_WORKSPACE/k8s-v1.27.13-offline-focal-amd64.tar.gz *
         ls -lh $GITHUB_WORKSPACE/k8s-*.tar.gz

     # 8. Release
     - name: Publish release
       uses: softprops/action-gh-release@v1
       with:
         tag_name: v1.27.13-offline-focal
         name: "Kubernetes v1.27.13 ç¦»çº¿åŒ…ï¼ˆUbuntu 20.04 Focalï¼‰"
         body: |
           âœ… å®Œå…¨ç¦»çº¿éƒ¨ç½²åŒ…ï¼Œé€‚ç”¨äºæ— ç½‘ç»œ Ubuntu 20.04 ç¯å¢ƒ

           åŒ…å«ï¼š
           - kubeadm / kubelet / kubectl (v1.27.13)
           - containerd + runc + CNIï¼ˆv1.6.24ï¼Œé¢„é…ç½® SystemdCgroup=trueï¼‰
           - crictl (v1.27.0)
           - Ubuntu 20.04 ç³»ç»Ÿä¾èµ– debï¼ˆå« iptables, bridge-utils, jq ç­‰ï¼‰
           - CNI æ’ä»¶ç‹¬ç«‹åŒ…ï¼ˆv1.3.0ï¼‰
           - æ‰€æœ‰æ ¸å¿ƒé•œåƒï¼ˆå« etcdã€corednsã€pauseï¼‰

           ğŸ“ ä½¿ç”¨æ–¹æ³•ï¼šè§£å‹åè¿è¡Œ install.sh
         files: k8s-v1.27.13-offline-focal-amd64.tar.gz
         draft: false
         prerelease: false
