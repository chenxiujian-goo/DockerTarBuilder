name: build-offline-pack-focal-in-ubuntu22   # 新名字，与旧文件区分

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pack:
    runs-on: ubuntu-22.04            # 只能选 22.04 或 latest
    steps:
      - uses: actions/checkout@v4

      # 1. 预先创建目录，把输出挂到容器外
      - name: mkdir
        run: mkdir -p $GITHUB_WORKSPACE/dist/{bins,images,debs,cni}

      # 2. 下载 k8s 二进制（宿主机做即可）
      - name: fetch binaries
        run: |
          VER=v1.27.13
          ARCH=amd64
          for bin in kubeadm kubelet kubectl; do
            curl -L -o $GITHUB_WORKSPACE/dist/bins/${bin} \
              https://dl.k8s.io/release/${VER}/bin/linux/${ARCH}/${bin}
            chmod +x $GITHUB_WORKSPACE/dist/bins/${bin}
          done

      # 3. 打包镜像（宿主机 Docker 可用）
      - name: save images
        run: |
          sudo systemctl start docker
          IMG=( \
            registry.k8s.io/kube-apiserver:v1.27.13 \
            registry.k8s.io/kube-controller-manager:v1.27.13 \
            registry.k8s.io/kube-scheduler:v1.27.13 \
            registry.k8s.io/kube-proxy:v1.27.13 \
            registry.k8s.io/pause:3.9 \
            registry.k8s.io/coredns/coredns:v1.10.1 \
          )
          for im in "${IMG[@]}"; do sudo docker pull "$im"; done
          sudo docker save "${IMG[@]}" | gzip > $GITHUB_WORKSPACE/dist/images/k8s-images.tar.gz

      # 4. 在 Ubuntu 20.04 容器里抓 focal 依赖
      - name: fetch focal debs via docker
        run: |
          docker run --rm -v $GITHUB_WORKSPACE/dist/debs:/out \
            ubuntu:20.04 bash -c \
            'apt-get update >/dev/null &&
             apt-get install --reinstall --download-only -y \
               conntrack ebtables ethtool ipset ipvsadm socat &&
             cp /var/cache/apt/archives/*.deb /out/'

      # 5. 下载 CNI 插件
      - name: cni-plugins
        run: |
          curl -L -o $GITHUB_WORKSPACE/dist/cni/cni-plugins.tgz \
            https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz

      # 6. 整体打包
      - name: bundle
        run: |
          cd $GITHUB_WORKSPACE/dist
          tar czf $GITHUB_WORKSPACE/k8s-v1.27.13-offline-focal-amd64.tar.gz *
          ls -lh $GITHUB_WORKSPACE/k8s-*.tar.gz

      # 7. 发布 Release
      - name: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.27.13-offline-focal
          name: "k8s v1.27.13 离线完整包（Ubuntu 20.04 focal amd64）"
          body: |
            包含：
            - kubeadm / kubelet / kubectl 二进制
            - Ubuntu 20.04 (focal) 官方依赖 deb 及完整依赖
            - 核心组件镜像（已 docker save）
            - CNI 插件
            使用方法见仓库 README。
          files: k8s-v1.27.13-offline-focal-amd64.tar.gz
          draft: false
          prerelease: false
