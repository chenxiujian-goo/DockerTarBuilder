name: Export Docker Images to Tar

on:
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Artifact retention days (1-90)'
        required: false
        default: '30'

env:
  IMAGE_APISIX: apache/apisix:3.9.1-debian
  IMAGE_ETCD: bitnami/etcd:3.5.14
  IMAGE_REDIS: redis:7.2.4
  IMAGE_POSTGRES: postgres:15-alpine
  IMAGE_NGINX: nginx:1.27.1
  IMAGE_GRAFANA: grafana/grafana:11.2.0
  IMAGE_ES: docker.elastic.co/elasticsearch/elasticsearch:8.9.0
  IMAGE_PROMETHEUS: quay.io/prometheus/prometheus:v2.54.0
  IMAGE_HIGRESS: higress-registry.cn-hangzhou.cr.aliyuncs.com/higress/all-in-one:2.1.6
  IMAGE_CASDOOR: zgsm/casdoor:v2.0.1
  IMAGE_CHATRAG: zgsm/chat-rag:v1.1.8
  IMAGE_CODE_COMPLETION: zgsm/code-completions:1.6.4
  IMAGE_OIDC_AUTH: zgsm/oidc-auth:v1.2.8
  IMAGE_ISSUE_MANAGER: zgsm/issue-manager:1.1.1
  IMAGE_REVIEW_CHECKER: zgsm/review-checker:1.1.3
  IMAGE_REVIEW_MANAGER: zgsm/review-manager:1.1.5
  IMAGE_CREDIT_MANAGER: zgsm/credit-manager:v1.1.6
  IMAGE_QUOTA_MANAGER: zgsm/quota-manager:1.0.20
  IMAGE_CHAT_SERVER: zgsm/chat-server:1.2.0
  IMAGE_COTUN: zgsm/cotun:v0.1.0
  IMAGE_TUNNEL_MANAGER: zgsm/tunnel-manager:v0.2.4
  IMAGE_CODEBASE_QUERIER: zgsm/codebase-querier:v0.1.4
  IMAGE_CODEBASE_EMBEDDER: zgsm/codebase-embedder:v0.1.1
  IMAGE_WEAVIATE: semitechnologies/weaviate:1.31.0

jobs:
  export-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af
          echo "=== After cleanup ==="
          df -h

      - name: Create output directory
        run: mkdir -p docker-images

      - name: Export APISIX
        run: |
          docker pull ${{ env.IMAGE_APISIX }}
          docker save ${{ env.IMAGE_APISIX }} | gzip > docker-images/apisix-3.9.1.tar.gz
          docker rmi ${{ env.IMAGE_APISIX }}
          docker system prune -f

      - name: Export ETCD
        run: |
          docker pull ${{ env.IMAGE_ETCD }}
          docker save ${{ env.IMAGE_ETCD }} | gzip > docker-images/etcd-3.5.14.tar.gz
          docker rmi ${{ env.IMAGE_ETCD }}
          docker system prune -f

      - name: Export Redis
        run: |
          docker pull ${{ env.IMAGE_REDIS }}
          docker save ${{ env.IMAGE_REDIS }} | gzip > docker-images/redis-7.2.4.tar.gz
          docker rmi ${{ env.IMAGE_REDIS }}
          docker system prune -f

      - name: Export Postgres
        run: |
          docker pull ${{ env.IMAGE_POSTGRES }}
          docker save ${{ env.IMAGE_POSTGRES }} | gzip > docker-images/postgres-15.tar.gz
          docker rmi ${{ env.IMAGE_POSTGRES }}
          docker system prune -f

      - name: Export Nginx
        run: |
          docker pull ${{ env.IMAGE_NGINX }}
          docker save ${{ env.IMAGE_NGINX }} | gzip > docker-images/nginx-1.27.1.tar.gz
          docker rmi ${{ env.IMAGE_NGINX }}
          docker system prune -f

      - name: Export Grafana
        run: |
          docker pull ${{ env.IMAGE_GRAFANA }}
          docker save ${{ env.IMAGE_GRAFANA }} | gzip > docker-images/grafana-11.2.0.tar.gz
          docker rmi ${{ env.IMAGE_GRAFANA }}
          docker system prune -f

      - name: Export Elasticsearch
        run: |
          docker pull ${{ env.IMAGE_ES }}
          docker save ${{ env.IMAGE_ES }} | gzip > docker-images/elasticsearch-8.9.0.tar.gz
          docker rmi ${{ env.IMAGE_ES }}
          docker system prune -f

      - name: Export Prometheus
        run: |
          docker pull ${{ env.IMAGE_PROMETHEUS }}
          docker save ${{ env.IMAGE_PROMETHEUS }} | gzip > docker-images/prometheus-v2.54.0.tar.gz
          docker rmi ${{ env.IMAGE_PROMETHEUS }}
          docker system prune -f

      - name: Export Higress
        run: |
          docker pull ${{ env.IMAGE_HIGRESS }}
          docker save ${{ env.IMAGE_HIGRESS }} | gzip > docker-images/higress-2.1.6.tar.gz
          docker rmi ${{ env.IMAGE_HIGRESS }}
          docker system prune -f

      - name: Export Casdoor
        run: |
          docker pull ${{ env.IMAGE_CASDOOR }}
          docker save ${{ env.IMAGE_CASDOOR }} | gzip > docker-images/casdoor-v2.0.1.tar.gz
          docker rmi ${{ env.IMAGE_CASDOOR }}
          docker system prune -f

      - name: Export Chat RAG
        run: |
          docker pull ${{ env.IMAGE_CHATRAG }}
          docker save ${{ env.IMAGE_CHATRAG }} | gzip > docker-images/chat-rag-v1.1.8.tar.gz
          docker rmi ${{ env.IMAGE_CHATRAG }}
          docker system prune -f

      - name: Export Code Completion
        run: |
          docker pull ${{ env.IMAGE_CODE_COMPLETION }}
          docker save ${{ env.IMAGE_CODE_COMPLETION }} | gzip > docker-images/code-completions-1.6.4.tar.gz
          docker rmi ${{ env.IMAGE_CODE_COMPLETION }}
          docker system prune -f

      - name: Export OIDC Auth
        run: |
          docker pull ${{ env.IMAGE_OIDC_AUTH }}
          docker save ${{ env.IMAGE_OIDC_AUTH }} | gzip > docker-images/oidc-auth-v1.2.8.tar.gz
          docker rmi ${{ env.IMAGE_OIDC_AUTH }}
          docker system prune -f

      - name: Export Issue Manager
        run: |
          docker pull ${{ env.IMAGE_ISSUE_MANAGER }}
          docker save ${{ env.IMAGE_ISSUE_MANAGER }} | gzip > docker-images/issue-manager-1.1.1.tar.gz
          docker rmi ${{ env.IMAGE_ISSUE_MANAGER }}
          docker system prune -f

      - name: Export Review Checker
        run: |
          docker pull ${{ env.IMAGE_REVIEW_CHECKER }}
          docker save ${{ env.IMAGE_REVIEW_CHECKER }} | gzip > docker-images/review-checker-1.1.3.tar.gz
          docker rmi ${{ env.IMAGE_REVIEW_CHECKER }}
          docker system prune -f

      - name: Export Review Manager
        run: |
          docker pull ${{ env.IMAGE_REVIEW_MANAGER }}
          docker save ${{ env.IMAGE_REVIEW_MANAGER }} | gzip > docker-images/review-manager-1.1.5.tar.gz
          docker rmi ${{ env.IMAGE_REVIEW_MANAGER }}
          docker system prune -f

      - name: Export Credit Manager
        run: |
          docker pull ${{ env.IMAGE_CREDIT_MANAGER }}
          docker save ${{ env.IMAGE_CREDIT_MANAGER }} | gzip > docker-images/credit-manager-v1.1.6.tar.gz
          docker rmi ${{ env.IMAGE_CREDIT_MANAGER }}
          docker system prune -f

      - name: Export Quota Manager
        run: |
          docker pull ${{ env.IMAGE_QUOTA_MANAGER }}
          docker save ${{ env.IMAGE_QUOTA_MANAGER }} | gzip > docker-images/quota-manager-1.0.20.tar.gz
          docker rmi ${{ env.IMAGE_QUOTA_MANAGER }}
          docker system prune -f

      - name: Export Chat Server
        run: |
          docker pull ${{ env.IMAGE_CHAT_SERVER }}
          docker save ${{ env.IMAGE_CHAT_SERVER }} | gzip > docker-images/chat-server-1.2.0.tar.gz
          docker rmi ${{ env.IMAGE_CHAT_SERVER }}
          docker system prune -f

      - name: Export Cotun
        run: |
          docker pull ${{ env.IMAGE_COTUN }}
          docker save ${{ env.IMAGE_COTUN }} | gzip > docker-images/cotun-v0.1.0.tar.gz
          docker rmi ${{ env.IMAGE_COTUN }}
          docker system prune -f

      - name: Export Tunnel Manager
        run: |
          docker pull ${{ env.IMAGE_TUNNEL_MANAGER }}
          docker save ${{ env.IMAGE_TUNNEL_MANAGER }} | gzip > docker-images/tunnel-manager-v0.2.4.tar.gz
          docker rmi ${{ env.IMAGE_TUNNEL_MANAGER }}
          docker system prune -f

      - name: Export Codebase Querier
        run: |
          docker pull ${{ env.IMAGE_CODEBASE_QUERIER }}
          docker save ${{ env.IMAGE_CODEBASE_QUERIER }} | gzip > docker-images/codebase-querier-v0.1.4.tar.gz
          docker rmi ${{ env.IMAGE_CODEBASE_QUERIER }}
          docker system prune -f

      - name: Export Codebase Embedder
        run: |
          docker pull ${{ env.IMAGE_CODEBASE_EMBEDDER }}
          docker save ${{ env.IMAGE_CODEBASE_EMBEDDER }} | gzip > docker-images/codebase-embedder-v0.1.1.tar.gz
          docker rmi ${{ env.IMAGE_CODEBASE_EMBEDDER }}
          docker system prune -f

      - name: Export Weaviate
        run: |
          docker pull ${{ env.IMAGE_WEAVIATE }}
          docker save ${{ env.IMAGE_WEAVIATE }} | gzip > docker-images/weaviate-1.31.0.tar.gz
          docker rmi ${{ env.IMAGE_WEAVIATE }}
          docker system prune -f

      - name: Create final archive
        run: |
          echo "=== Creating final archive ==="
          tar -czf all-docker-images.tar.gz docker-images/
          ls -lh all-docker-images.tar.gz
          echo "=== Archive contents ==="
          tar -tzf all-docker-images.tar.gz | head -30

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-docker-images
          path: all-docker-images.tar.gz
          retention-days: ${{ github.event.inputs.retention_days || 30 }}
          compression-level: 0  # Already compressed

      - name: Summary
        run: |
          echo "## Docker Images Export Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Exported Images:" >> $GITHUB_STEP_SUMMARY
          ls -lh docker-images/*.tar.gz | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Final Archive:" >> $GITHUB_STEP_SUMMARY
          ls -lh all-docker-images.tar.gz | awk '{print "- **" $9 "** - Size: **" $5 "**"}' >> $GITHUB_STEP_SUMMARY
