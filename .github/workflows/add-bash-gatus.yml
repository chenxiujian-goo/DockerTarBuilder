name: Add Bash to Gatus and Export as Tar

on:
  workflow_dispatch:

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    steps:
      - name: Pull original gatus image
        run: docker pull ghcr.io/twin/gatus:stable

      - name: Create Dockerfile to add Bash
        run: |
          cat > Dockerfile << 'EOF'
          FROM ghcr.io/twin/gatus:stable AS original

          FROM alpine:latest
          RUN apk --no-cache add ca-certificates bash
          COPY --from=original /gatus /gatus
          COPY --from=original /config/config.yaml /config/config.yaml
          EXPOSE 8080
          ENTRYPOINT ["/gatus"]
          EOF

      - name: Build new image with Bash
        run: docker build -t gatus-with-bash .

      - name: Verify Bash is installed
        run: |
          CONTAINER_ID=$(docker create gatus-with-bash)
          if docker export "$CONTAINER_ID" | tar -t | grep -q '^bin/bash$'; then
            echo "✅ Bash found!"
          else
            echo "❌ Bash missing!"
            exit 1
          fi
          docker rm "$CONTAINER_ID"

      - name: Save image as tar
        run: docker save gatus-with-bash -o gatus-with-bash.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gatus-with-bash.tar
          path: gatus-with-bash.tar
          retention-days: 7
